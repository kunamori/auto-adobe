name: Update User-Agent and Expiration Date

on:
  schedule:
    - cron: '0 0 1 * *'  # Runs at midnight on the first day of each month
  workflow_dispatch:  # Allows manual triggering

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2

      - name: Set up Python
        uses: actions/setup-python@v5.4.0
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: pip install requests

      - name: Update User-Agent and Expiration Date
        id: update_script
        run: |
          python - <<EOF
          import re
          import requests
          from datetime import datetime, timedelta
          import calendar
          
          # Get latest Firefox version
          try:
              firefox_response = requests.get("https://product-details.mozilla.org/1.0/firefox_versions.json")
              firefox_data = firefox_response.json()
              firefox_version = firefox_data.get("LATEST_FIREFOX_VERSION", "135.0")  # Default if fetch fails
          except Exception:
              firefox_version = "135.0"  # Default fallback
          
          # Calculate expiration date (first day of next month)
          today = datetime.now()
          # Get the first day of the next month
          if today.month == 12:
              next_month = datetime(today.year + 1, 1, 1)
          else:
              next_month = datetime(today.year, today.month + 1, 1)
          
          # If we want to set it to first day of month after next
          if today.month == 11:
              after_next_month = datetime(today.year + 1, 1, 1)
          elif today.month == 12:
              after_next_month = datetime(today.year + 1, 2, 1)
          else:
              after_next_month = datetime(today.year, today.month + 2, 1)
          
          # Format the date as YYYY-MM-DD
          new_date = after_next_month.strftime("%Y-%m-%d")
          
          # Read the payload.py file
          with open('payload.py', 'r') as file:
              content = file.read()
          
          # Update the User-Agent with latest Firefox version
          updated_content = re.sub(
              r'(User-Agent": "Mozilla/5\.0 \(X11; Linux x86_64; rv:)\d+(\.\d+)?',
              f'User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:{firefox_version}',
              content
          )
          
          # Update the date_expire - Using a more robust pattern that handles spacing
          updated_content = re.sub(
              r'(\s*"date_expire":\s*")\d{4}-\d{2}-\d{2}(")',
              f'\\1{new_date}\\2',
              updated_content
          )
          
          # In case the field is missing, check and add it back if needed
          if '"date_expire":' not in updated_content:
              # Find where to insert the field (after userId field)
              updated_content = re.sub(
                  r'("userId":\s*\'.*?\')',
                  f'\\1,\n        "date_expire": "{new_date}"',
                  updated_content
              )
          
          # Write the updated content back
          with open('payload.py', 'w') as file:
              file.write(updated_content)
          
          print(f"Updated User-Agent to Firefox {firefox_version}")
          print(f"Updated expiration date to {new_date}")
          EOF

      - name: Commit and push if changes
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add payload.py
          git diff --quiet && git diff --staged --quiet || git commit -m "Update User-Agent version and expiration date for $(date +'%B %Y')"
          git push